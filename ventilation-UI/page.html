<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="style/style.css">
</head>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
<body>
    <div class="all">
        <h1>The control center!</h1>
        <a class="logout" href="/logout">Logout</a> <br>
        <div class="upper">

            <h4>Select the the options for the Mode</h4>
            <form class="form"action="javascript:submitform()">
                <tr>
                    <td><input class="option-input radio" id="manual" type="radio" name="mode" oninput="changeMode()" checked>Manual</td>
                    <td> <input class="option-input radio" id="auto" type="radio" name="mode" oninput="changeMode()">Auto</td>
                </tr>
                <h4 id="targetHeader">Target speed</h4>
                <input class="range" id="targetValue" type="range" min="0" max="100" oninput="document.getElementById('sliderOutput').value = this.value"><br>
                <input class="value" id="sliderOutput" type="number" value="50" oninput="document.getElementById('targetValue').value = this.value">
                <input class="button" type="submit">
            </form>
        </div>

        <div class="lower">
                <div class="speed">
                    <h4>Speed</h4>
                    <p id="Speed">0</p>
                </div>
                <div class="pressure">
                    <h4>Pressure</h4>
                    <p id="Pressure">0</p>
                </div>
                <div class ="co">
                    <h4>CO2</h4>
                    <p id="CO2">0</p>
                </div>
                <div class="rh">
                    <h4>RH</h4>
                    <p id="RH">0</p>
                </div>
                <div class ="temp">
                    <h4>Temp</h4>
                    <p id="Temp">0</p>
                </div>
        </div>
    </div>

    <canvas id="myChart" style="width:100%;max-width:1000px;margin:auto"></canvas>














            <div class='py'>
                <label>
                    <input type="radio" class="option-input radio" name="example" checked />
                    Radio option
                </label>
            </div>





</body>
</html>

<script>
    let savedSetpoint, savedMode;
    function update() {
        fetch('/data/update', {
            method: 'get'
        }).then(async function (res) {
            let dataJson = JSON.parse(await res.text());
            if (savedSetpoint !== dataJson["setpoint"] || savedMode !== dataJson["auto"]) {
                if (dataJson["auto"]) {
                    document.getElementById("auto").checked = true;
                } else {
                    document.getElementById("manual").checked = true;
                }
                savedSetpoint = dataJson["setpoint"];
                savedMode = dataJson["auto"];
                changeMode(parseInt(dataJson["setpoint"]));
            }
            document.getElementById("Speed").innerText = dataJson["speed"] + "%";
            document.getElementById("Pressure").innerText = dataJson["pressure"] + " Pa";
            document.getElementById("CO2").innerText = dataJson["co2"] + " ppm";
            document.getElementById("RH").innerText = dataJson["rh"] + " %RH";
            document.getElementById("Temp").innerText = dataJson["temp"] + " Â°C";
        });
    }

    function submitform() {
        let auto = document.getElementById("auto");
        let mode = auto.checked ? "pressure" : "speed";
        let json = {
            "auto": auto.checked,
            [mode]: parseInt(document.getElementById("targetValue").value)
        }

        fetch('/send', {
            method: 'POST',
            body: JSON.stringify(json),
            headers: {
                "Content-Type": "application/json"
            }
        });
    }

    function changeMode(target) {
        let header = document.getElementById("targetHeader");
        let slider = document.getElementById("targetValue");
        let output = document.getElementById("sliderOutput");

        if (document.getElementById("auto").checked) {
            header.innerText = "Target pressure";
            slider.setAttribute("max", "120");
            slider.value = target !== undefined ? target : 60;
            output.value = target !== undefined ? target : 60;
        } else {
            header.innerText = "Target speed";
            slider.setAttribute("max", "100");
            slider.value = target !== undefined ? target : 50;
            output.value = target !== undefined ? target : 50;
        }
        update();
    }

    function getVentilationData() {
        fetch('/data/ventilation', {
            method: 'get'
        }).then(async function (res) {
            let dataJson = JSON.parse(await res.text());
            let timeData = [];
            let setpointData = [];
            for (let i = 0; i < dataJson.length; i++) {
                timeData.push(dataJson[i]["timestamp"]);
                setpointData.push(parseInt(dataJson[i]["pressure"]));
            }
            new Chart("myChart", {
                type: "line",
                data: {
                    labels: timeData,
                    datasets: [{
                        borderColor: "black",
                        borderWidth: 0,
                        pointRadius: 0,
                        data: setpointData
                    }]
                }
            });
        });
    }
    getVentilationData();

    setInterval(update, 500);
</script>

